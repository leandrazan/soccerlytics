---
title: "xT"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{xT}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Position-based expected threat (xT) model

We implement the position-based xT model as explained in Section 4 of Soccermatics
(<https://soccermatics.readthedocs.io/en/latest/lesson4/xTPos.html>). The model can be 
attributed to Karun Singh (see <https://karun.in/blog/expected-threat.html> for the 
original post).

To every location of the pitch, the model assigns a value representing the expected threat ($xT$)
at the respective position. Here, the expected threat consists of the threat generated by 
shooting from the location plus the threat generated by moving the ball. 
Mathematically, there are several probabilities that play a role within the model .

For a given location $(x,y)$,

  * $s_{x,y}$ denotes the probability of shooting from location $(x,y)$
  * $g_{x,y}$ denotes the probability of scoring from position $(x,y)$ given that a 
  shot is taken
  * $m_{x,y}$ denotes the probability that the ball is moved (and no shot is taken, 
  i.e. $m_{x,y} = 1 - s_{x,y}$)
  * $T_{(x,y) \to (z,w)}$ denotes the probability of moving the from location $(x,y)$ 
  to location $(z,w)$ given that the ball is moved.
  
We are going to use event data from La Liga Season 2019/2020 and 2020/2021, provided by 
StatsBomb (<https://github.com/statsbomb/open-data>). The data was transformed to 
SPADL format 
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(soccerlytics)
data("spadlData")
```
```{r}
spadlData
```

We are going to divide the pitch into $12\cdot16 = 192$ cells, 16 cells in `x` 
direction and 12 cells in `y` direction. 

The function `prepare_data` assigns cells to start and end point of each action 
and further returns the cell centers, which is useful for plotting heatmaps.

```{r, fig.dim=c(12.5, 8),  out.width="85%", fig.align='center'}
prep_dat <- prepare_data(spadlData)
# visualise grid:
prep_dat$bin_centers %>%
  ggplot(aes( x  = x_center, y = y_center))+
  geom_tile(fill = "white", colour = "gray") +
  geom_text(aes( label = paste0("x:", bin_start_x, ", y:", bin_start_y))) +
  draw_pitch(c(105, 68), fill = NA)+ 
  theme(axis.title = element_blank())
```

Now we compute the probabiliies for moving the ball, shooting and scoring 
for each cell on the pitch.

```{r}
df_prob <- compute_action_prob(prep_dat$prep_data)
df_prob
```
Let's visualise these probabilities:

```{r, fig.dim=c(14, 5), out.width="99%",  fig.align='center'}
prep_dat$bin_centers %>% left_join(df_prob, by = c("bin_start_x", "bin_start_y")) %>% 
  pivot_longer(cols = c(move_prob, shot_prob, goal_prob), names_to = "type", values_to = "prob_value") %>% 
  ggplot(aes( x = x_center, y = y_center, fill = prob_value))+ 
  scale_fill_gradient(low = "white", high = "darkred")+
  geom_tile(colour = "gray")+ 
  draw_pitch(dimensions = c(105, 68), fill = NA)+
  facet_wrap(~type)+ 
  labs(fill = "probability:")+
  theme(legend.position = "bottom", axis.title = element_blank(), 
        text = element_text(size = 20), legend.key.width = unit(1, "cm"))
```

The transition matrices can be computed with the function 
`compute_trans_mat`. Later on, this function is called within the `compute_xT` function, 
but for illustrative purposes it is shown here. 

```{r}
tms <- compute_trans_mat(prep_dat$prep_data)
tms
tms[100, ]$trans_probs
```
The last tibble shows the transition probabilities from the cell starting at the 1st bin in 
x direction and in the 11th bin in y direction, to any cell of the pitch.
Many of the transition probabilities are 0, because no transitions have been observed to the 
respective cell. The transition probabilities do seem a bit unrealistic, which is probably 
due to an erroneous transformation from Statsbomb to SPADL format. 
We can visualise the transition probabilites:

```{r, fig.dim = c(12, 8), out.width="75%", fig.align='center'}
prep_dat$bin_centers %>% 
  left_join(tms[11, ]$trans_probs[[1]], by = c("bin_start_x" = "bin_end_x", "bin_start_y" = "bin_end_y")) %>% 
  ggplot(aes( x = x_center, y = y_center, fill = trans_prob)) + 
  scale_fill_gradient(low = "white", high = "darkgreen")+
  geom_tile(colour = "gray")+ 
  geom_text(aes(label = round(trans_prob, 2)))+
  draw_pitch(dimensions = c(105, 68), fill = NA)+
  labs(fill = "transition probability:")+
  theme(legend.position = "bottom", axis.title = element_blank(), text = element_text(size = 20), legend.key.width = unit(1, "cm"))

```
Now we compute the expected threat with the function `compute_xT` with 5 iterations.

```{r}
xT <- compute_xT(prep_dat$prep_data, itermax = 5, eps = 1e-03)
xT$xT_final
```
```{r, fig.dim = c(12, 8), out.width="75%", fig.align='center'}
## plot heatmap of xT:
xT_tib <- prep_dat$bin_centers %>% left_join(xT$xT_final)

xT_tib %>% ggplot(aes( x = x_center, y = y_center, fill = xT)) +
  geom_tile(width = 105/16, height = 68/12, colour = "gray")+
  scale_fill_gradient(low = "white", high = "darkred")+
  draw_pitch(dimensions = c(105, 68), fill = NA)+
  geom_text(aes(label = round(xT, 2)))+ 
  theme(text = element_text(size = 20), axis.title = element_blank())+ 
  ggtitle("xT after 5 iterations")
```

